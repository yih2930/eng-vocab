<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±å˜èªãƒœã‚­ãƒ£ãƒ–ãƒ©500</title>
    <script src="data.js"></script>
    <style>
        :root { --primary: #4A90E2; --success: #47C78E; --error: #FF6B6B; --bg: #F0F2F5; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 500px; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); padding: 20px; min-height: 90vh; display: flex; flex-direction: column; box-sizing: border-box; }
        h2 { text-align: center; color: #333; font-size: 1.2rem; margin-top: 0; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .chapter-btn { padding: 15px; border: 1px solid #DDD; border-radius: 12px; background: white; text-align: left; cursor: pointer; position: relative; }
        .chapter-btn .date { font-size: 0.7rem; color: #888; display: block; margin-top: 5px; }
        .chapter-btn.done { border-color: var(--success); background: #F6FFF9; }
        .review-btn { background: #666; color: white; padding: 15px; border-radius: 12px; text-align: center; margin-top: 20px; font-weight: bold; width: 100%; border: none; cursor: pointer; font-size: 1rem; }
        
        .quiz-header { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #888; margin-bottom: 15px; background: #F8F9FA; padding: 8px; border-radius: 8px; }
        .quit-btn { background: #EEE; border: none; border-radius: 4px; font-size: 0.7rem; padding: 4px 8px; color: #666; cursor: pointer; }
        
        .jp { font-size: 1.3rem; font-weight: bold; margin-bottom: 20px; color: #333; min-height: 3rem; line-height: 1.4; }
        .options { display: grid; gap: 10px; }
        .opt-btn { padding: 14px; border: 2px solid #EEE; border-radius: 12px; background: white; font-size: 1.1rem; text-align: left; cursor: pointer; transition: 0.2s; color: #444; }
        
        .feedback { margin-top: 15px; padding: 15px; border-radius: 12px; display: none; background: #F9F9F9; border: 1px solid #EEE; }
        .feedback.show { display: block; }
        .phrase { font-style: italic; margin: 10px 0; font-size: 1.15rem; color: #000; line-height: 1.4; border-left: 3px solid var(--primary); padding-left: 10px; }
        .voice-btn { background: #666; color: white; border: none; padding: 12px 20px; border-radius: 25px; cursor: pointer; margin-bottom: 15px; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        .next-btn { width: 100%; padding: 16px; background: var(--success); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
        
        .hidden { display: none; }
        .result-screen { text-align: center; padding: 20px; }
        .score { font-size: 3.5rem; font-weight: bold; color: var(--primary); margin: 20px 0; }
        .home-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; margin-top: 20px; cursor: pointer; font-size: 1.1rem; }
    </style>
</head>
<body>
<div class="container">
    <div id="menu-screen">
        <h2>ç« ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
        <div id="chapter-list" class="menu-grid"></div>
        <div id="review-area"></div>
    </div>

    <div id="quiz-screen" class="hidden">
        <div class="quiz-header">
            <div><span id="current-info"></span> (<span id="progress-text"></span>)</div>
            <button class="quit-btn" onclick="confirmQuit()">ä¸­æ­¢ã—ã¦æˆ»ã‚‹</button>
        </div>
        <div id="sit" style="color:var(--primary); font-weight:bold; font-size:0.85rem; margin-bottom:8px;"></div>
        <div id="jp" class="jp"></div>
        <div id="opts" class="options"></div>
        
        <div id="fb" class="feedback">
            <div id="res" style="font-weight:bold; font-size:1.2rem; margin-bottom:10px;"></div>
            <div id="phrase" class="phrase"></div>
            <button class="voice-btn" onclick="speakCurrent()">ğŸ”Š ç™ºéŸ³ã‚’èã</button>
            <button class="next-btn" onclick="nextQuestion()">æ¬¡ã®å•é¡Œã¸</button>
        </div>
    </div>

    <div id="result-screen" class="result-screen hidden">
        <h2 id="result-title">Chapter ã‚¯ãƒªã‚¢ï¼</h2>
        <div class="score" id="final-score">0 / 0</div>
        <p id="result-msg" style="color:#666;"></p>
        <button class="home-btn" onclick="showMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
    </div>
</div>

<script>
let currentChapter = 0;
let currentIndex = 0;
let score = 0;
let quizPool = [];
let mistakes = JSON.parse(localStorage.getItem('mistakes') || '[]');
let history = JSON.parse(localStorage.getItem('history') || '{}');

function showMenu() {
    document.getElementById('menu-screen').classList.remove('hidden');
    document.getElementById('quiz-screen').classList.add('hidden');
    document.getElementById('result-screen').classList.add('hidden');
    
    const list = document.getElementById('chapter-list');
    list.innerHTML = '';
    
    // ç« ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ãªãŒã‚‰25ç« åˆ†ä½œæˆ
    for (let i = 1; i <= 25; i++) {
        const btn = document.createElement('div');
        const isDone = history[i];
        const hasData = (typeof allChapters !== 'undefined' && allChapters[i]);
        
        btn.className = `chapter-btn ${isDone ? 'done' : ''}`;
        if (!hasData) btn.style.opacity = '0.5';
        
        btn.innerHTML = `ç¬¬${i}ç«  ${isDone ? '<span class="date">æ¸ˆ: ' + isDone + '</span>' : ''}`;
        btn.onclick = () => startChapter(i);
        list.appendChild(btn);
    }

    const reviewArea = document.getElementById('review-area');
    reviewArea.innerHTML = mistakes.length > 0 ? 
        `<button class="review-btn" onclick="startReview()">å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ (${mistakes.length}èª)</button>` : '';
}

function startChapter(chapterNum) {
    if (typeof allChapters === 'undefined' || !allChapters[chapterNum]) {
        alert("ç¬¬" + chapterNum + "ç« ã®ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã æº–å‚™ä¸­ã§ã™ï¼");
        return;
    }
    currentChapter = chapterNum;
    quizPool = [...allChapters[chapterNum]].sort(() => Math.random() - 0.5);
    initQuiz();
}

function startReview() {
    currentChapter = 'å¾©ç¿’';
    quizPool = [...mistakes].sort(() => Math.random() - 0.5);
    initQuiz();
}

function initQuiz() {
    currentIndex = 0;
    score = 0;
    document.getElementById('menu-screen').classList.add('hidden');
    document.getElementById('quiz-screen').classList.remove('hidden');
    document.getElementById('result-screen').classList.add('hidden');
    loadQuestion();
}

function loadQuestion() {
    const q = quizPool[currentIndex];
    document.getElementById('current-info').innerText = currentChapter === 'å¾©ç¿’' ? 'å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰' : `ç¬¬${currentChapter}ç« `;
    document.getElementById('progress-text').innerText = `${currentIndex + 1} / ${quizPool.length}`;
    document.getElementById('sit').innerText = q.s;
    document.getElementById('jp').innerText = q.j;
    document.getElementById('fb').classList.remove('show');
    
    const opts = document.getElementById('opts');
    opts.innerHTML = '';
    const choices = [q.e, ...q.d].sort(() => Math.random() - 0.5);
    choices.forEach(o => {
        const b = document.createElement('button');
        b.className = 'opt-btn'; b.innerText = o;
        b.onclick = () => checkAnswer(o, q.e, b);
        opts.appendChild(b);
    });
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€ç•ªä¸Šã«æˆ»ã™
    window.scrollTo(0,0);
}

function checkAnswer(selected, correct, btn) {
    const isCorrect = selected === correct;
    const q = quizPool[currentIndex];
    
    // ä»–ã®å…¨ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã€æ­£è§£ã‚’ç·‘æ ã«ã™ã‚‹
    document.querySelectorAll('.opt-btn').forEach(b => {
        b.onclick = null;
        if(b.innerText === correct) {
            b.style.borderColor = 'var(--success)';
            b.style.borderWidth = '3px';
        }
    });

    if (isCorrect) {
        score++;
        btn.style.backgroundColor = '#F6FFF9';
        // æ­£è§£ã—ãŸå˜èªã‚’å¾©ç¿’ãƒªã‚¹ãƒˆã‹ã‚‰é™¤å¤–
        mistakes = mistakes.filter(m => m.e !== q.e);
    } else {
        btn.style.borderColor = 'var(--error)';
        btn.style.backgroundColor = '#FFF6F6';
        // é–“é•ãˆãŸå˜èªã‚’å¾©ç¿’ãƒªã‚¹ãƒˆã«è¿½åŠ 
        if (!mistakes.some(m => m.e === q.e)) {
            mistakes.push(q);
        }
    }
    localStorage.setItem('mistakes', JSON.stringify(mistakes));

    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
    document.getElementById('res').innerText = isCorrect ? "â­• æ­£è§£ï¼" : "âŒ ä¸æ­£è§£...";
    document.getElementById('res').style.color = isCorrect ? 'var(--success)' : 'var(--error)';
    document.getElementById('phrase').innerText = q.p;
    document.getElementById('fb').classList.add('show');
    
    // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§è§£èª¬ã‚’è¦‹ã‚„ã™ãã™ã‚‹
    setTimeout(() => {
        document.getElementById('fb').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
}

function nextQuestion() {
    currentIndex++;
    if (currentIndex < quizPool.length) {
        loadQuestion();
    } else {
        finishChapter();
    }
}

function finishChapter() {
    document.getElementById('quiz-screen').classList.add('hidden');
    document.getElementById('result-screen').classList.remove('hidden');
    document.getElementById('final-score').innerText = `${score} / ${quizPool.length}`;
    
    const msg = document.getElementById('result-msg');
    if (score === quizPool.length) {
        msg.innerText = "å…¨å•æ­£è§£ï¼ç´ æ™´ã‚‰ã—ã„ã§ã™ï¼";
        // å…¨å•æ­£è§£ã—ãŸæ™‚ã®ã¿ã€ç« é¸æŠç”»é¢ã«æ—¥ä»˜ã‚’è¨˜éŒ²
        if (currentChapter !== 'å¾©ç¿’') {
            const today = new Date().toLocaleDateString('ja-JP');
            history[currentChapter] = today;
            localStorage.setItem('history', JSON.stringify(history));
        }
    } else {
        msg.innerText = "é–“é•ãˆãŸå•é¡Œã¯å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã§è§£ãç›´ã›ã¾ã™ã€‚";
    }
}

function confirmQuit() {
    if (confirm("ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ\nï¼ˆç¾åœ¨ã®é€²æ—ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼‰")) {
        showMenu();
    }
}

function speakCurrent() {
    if (!quizPool[currentIndex]) return;
    const u = new SpeechSynthesisUtterance(quizPool[currentIndex].p);
    u.lang = 'en-US'; u.rate = 0.9;
    speechSynthesis.speak(u);
}

// èµ·å‹•æ™‚ã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
window.onload = showMenu;
</script>
</body>
</html>
