<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±å˜èªãƒœã‚­ãƒ£ãƒ–ãƒ©500</title>
    <style>
        :root { --primary: #4A90E2; --success: #47C78E; --error: #FF6B6B; --bg: #F0F2F5; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 500px; border-radius: 20px; shadow: 0 8px 30px rgba(0,0,0,0.1); padding: 20px; min-height: 90vh; display: flex; flex-direction: column; }
        h2 { text-align: center; color: #333; font-size: 1.2rem; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .chapter-btn { padding: 15px; border: 1px solid #DDD; border-radius: 12px; background: white; text-align: left; cursor: pointer; position: relative; }
        .chapter-btn .date { font-size: 0.7rem; color: #888; display: block; margin-top: 5px; }
        .chapter-btn.done { border-color: var(--success); background: #F6FFF9; }
        .review-btn { grid-column: span 2; background: #666; color: white; padding: 15px; border-radius: 12px; text-align: center; margin-top: 10px; font-weight: bold; }
        
        .quiz-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-bottom: 15px; }
        .jp { font-size: 1.3rem; font-weight: bold; margin-bottom: 20px; color: #333; min-height: 3rem; }
        .options { display: grid; gap: 10px; }
        .opt-btn { padding: 14px; border: 2px solid #EEE; border-radius: 12px; background: white; font-size: 1rem; text-align: left; cursor: pointer; }
        .feedback { margin-top: 15px; padding: 15px; border-radius: 12px; display: none; background: #F9F9F9; }
        .phrase { font-style: italic; margin: 10px 0; font-size: 1.1rem; color: #000; }
        .voice-btn { background: #666; color: white; border: none; padding: 10px 18px; border-radius: 20px; cursor: pointer; }
        
        .hidden { display: none; }
        .result-screen { text-align: center; padding: 20px; }
        .score { font-size: 3rem; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>
<div class="container">
    <div id="menu-screen">
        <h2>ç« ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
        <div id="chapter-list" class="menu-grid"></div>
        <div id="review-section"></div>
    </div>

    <div id="quiz-screen" class="hidden">
        <div class="quiz-header">
            <span id="current-info">Chapter 1</span>
            <span id="progress-text">1 / 20</span>
        </div>
        <div id="sit" style="color:var(--primary); font-weight:bold; font-size:0.8rem; margin-bottom:5px;"></div>
        <div id="jp" class="jp"></div>
        <div id="opts" class="options"></div>
        <div id="fb" class="feedback">
            <div id="res" style="font-weight:bold; margin-bottom:5px;"></div>
            <div id="phrase" class="phrase"></div>
            <button class="voice-btn" onclick="speakCurrent()">ğŸ”Š ç™ºéŸ³ã‚’èã</button>
            <button onclick="nextQuestion()" style="margin-top:15px; width:100%; padding:12px; background:var(--success); color:white; border:none; border-radius:8px; font-weight:bold;">æ¬¡ã¸</button>
        </div>
    </div>

    <div id="result-screen" class="result-screen hidden">
        <h2>Chapter ã‚¯ãƒªã‚¢ï¼</h2>
        <div class="score" id="final-score">0 / 20</div>
        <p id="score-comment"></p>
        <button onclick="showMenu()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:12px; font-weight:bold; margin-top:20px;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
    </div>
</div>

<script>
// --- å˜èªãƒ‡ãƒ¼ã‚¿ (20èª1ã‚»ãƒƒãƒˆã€‚ã“ã“ã«500èªã¾ã§è¿½åŠ å¯èƒ½) ---
const allChapters = {
    1: [
        { s: "æ™‚é–“ã‚’ãšã‚‰ã—ãŸã„æ™‚", j: "ã€œã‚’å»¶æœŸã™ã‚‹", e: "Postpone", d: ["Cancel", "Hurry", "Avoid"], p: "Can we postpone the meeting?" },
        { s: "æ—¥ç¨‹ã‚’çµ„ã¿ç›´ã™æ™‚", j: "ã€œã®äºˆå®šã‚’å¤‰æ›´ã™ã‚‹", e: "Reschedule", d: ["Confirm", "Repeat", "Reduce"], p: "I need to reschedule our appointment." },
        { s: "å¿™ã—ã„æ™‚", j: "æ‰‹ãŒé›¢ã›ãªã„", e: "Be tied up", d: ["Be free", "Be ready", "Be late"], p: "I'm tied up at the moment." },
        { s: "èª°ã‹ã‚’è¿ãˆã«è¡Œãæ™‚", j: "ï¼ˆäººã‚’ï¼‰è¿ãˆã«è¡Œã", e: "Pick up", d: ["Drop off", "Look for", "Take out"], p: "I'll pick you up at 7." },
        // ... (ã“ã“ã«1ç« åˆ†20èªç¶šã)
    ],
    2: [
        { s: "é€£çµ¡ã‚’å–ã‚‹æ™‚", j: "ã€œã«é€£çµ¡ã™ã‚‹", e: "Contact", d: ["Contract", "Contain", "Confirm"], p: "I'll contact you later." },
        // ... (ã“ã“ã«2ç« åˆ†20èªç¶šã)
    ]
};

// --- ã‚¢ãƒ—ãƒªã®ãƒ­ã‚¸ãƒƒã‚¯ ---
let currentChapter = 0;
let currentIndex = 0;
let score = 0;
let quizPool = [];
let mistakes = JSON.parse(localStorage.getItem('mistakes') || '[]');
let history = JSON.parse(localStorage.getItem('history') || '{}');

function showMenu() {
    document.getElementById('menu-screen').classList.remove('hidden');
    document.getElementById('quiz-screen').classList.add('hidden');
    document.getElementById('result-screen').classList.add('hidden');
    
    const list = document.getElementById('chapter-list');
    list.innerHTML = '';
    for (let i = 1; i <= 25; i++) {
        const btn = document.createElement('div');
        const isDone = history[i];
        btn.className = `chapter-btn ${isDone ? 'done' : ''}`;
        btn.innerHTML = `ç¬¬${i}ç«  ${isDone ? '<span class="date">æ¸ˆ: ' + isDone + '</span>' : ''}`;
        btn.onclick = () => startChapter(i);
        list.appendChild(btn);
    }

    const reviewSection = document.getElementById('review-section');
    reviewSection.innerHTML = mistakes.length > 0 ? 
        `<button class="review-btn" onclick="startReview()">å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ (${mistakes.length}èª)</button>` : '';
}

function startChapter(chapterNum) {
    if(!allChapters[chapterNum]) return alert("ç¾åœ¨ãƒ‡ãƒ¼ã‚¿æº–å‚™ä¸­ã§ã™ï¼");
    currentChapter = chapterNum;
    quizPool = [...allChapters[chapterNum]].sort(() => Math.random() - 0.5);
    initQuiz();
}

function startReview() {
    currentChapter = 'å¾©ç¿’';
    quizPool = [...mistakes].sort(() => Math.random() - 0.5);
    initQuiz();
}

function initQuiz() {
    currentIndex = 0;
    score = 0;
    document.getElementById('menu-screen').classList.add('hidden');
    document.getElementById('quiz-screen').classList.remove('hidden');
    loadQuestion();
}

function loadQuestion() {
    const q = quizPool[currentIndex];
    document.getElementById('current-info').innerText = currentChapter === 'å¾©ç¿’' ? 'å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰' : `Chapter ${currentChapter}`;
    document.getElementById('progress-text').innerText = `${currentIndex + 1} / ${quizPool.length}`;
    document.getElementById('sit').innerText = q.s;
    document.getElementById('jp').innerText = q.j;
    document.getElementById('fb').classList.remove('show');
    
    const opts = document.getElementById('opts');
    opts.innerHTML = '';
    const choices = [q.e, ...q.d].sort(() => Math.random() - 0.5);
    choices.forEach(o => {
        const b = document.createElement('button');
        b.className = 'opt-btn'; b.innerText = o;
        b.onclick = () => checkAnswer(o, q.e, b);
        opts.appendChild(b);
    });
}

function checkAnswer(selected, correct, btn) {
    const isCorrect = selected === correct;
    const q = quizPool[currentIndex];
    
    if (isCorrect) {
        score++;
        btn.style.borderColor = 'var(--success)';
        btn.style.backgroundColor = '#F6FFF9';
        // æ­£è§£ã—ãŸã‚‰å¾©ç¿’ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
        mistakes = mistakes.filter(m => m.e !== q.e);
    } else {
        btn.style.borderColor = 'var(--error)';
        btn.style.backgroundColor = '#FFF6F6';
        // é–“é•ãˆãŸã‚‰å¾©ç¿’ãƒªã‚¹ãƒˆã¸ï¼ˆé‡è¤‡ãªã—ï¼‰
        if (!mistakes.some(m => m.e === q.e)) mistakes.push(q);
    }
    localStorage.setItem('mistakes', JSON.stringify(mistakes));

    document.getElementById('res').innerText = isCorrect ? "â­• æ­£è§£ï¼" : "âŒ æ­£è§£ã¯ " + correct;
    document.getElementById('res').style.color = isCorrect ? 'var(--success)' : 'var(--error)';
    document.getElementById('phrase').innerText = q.p;
    document.getElementById('fb').classList.add('show');
    document.querySelectorAll('.opt-btn').forEach(b => b.onclick = null); // é€£æ‰“é˜²æ­¢
}

function nextQuestion() {
    currentIndex++;
    if (currentIndex < quizPool.length) {
        loadQuestion();
    } else {
        finishChapter();
    }
}

function finishChapter() {
    document.getElementById('quiz-screen').classList.add('hidden');
    document.getElementById('result-screen').classList.remove('hidden');
    document.getElementById('final-score').innerText = `${score} / ${quizPool.length}`;
    
    if (currentChapter !== 'å¾©ç¿’') {
        const today = new Date().toLocaleDateString();
        history[currentChapter] = today;
        localStorage.setItem('history', JSON.stringify(history));
    }
}

function speakCurrent() {
    const u = new SpeechSynthesisUtterance(quizPool[currentIndex].p);
    u.lang = 'en-US'; u.rate = 0.9;
    speechSynthesis.speak(u);
}

showMenu();
</script>
</body>
</html>
